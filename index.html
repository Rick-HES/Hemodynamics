<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hemodynamics Interactive — Resistance & Redistribution</title>
  <style>
    :root{
      --bg:#f8f4ef;
      --panel:#ffffff;
      --panel2:#f3ede5;
      --text:#2b2b2b;
      --muted:#5f5f5f;
      --border:rgba(0,0,0,.12);

      --accent:#8b2f2f;    /* burgundy */
      --accent2:#d4a017;   /* amber */

      --shadow: 0 10px 26px rgba(0,0,0,.10);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(900px 520px at 18% 0%, rgba(139,47,47,.10) 0%, rgba(248,244,239,1) 55%),
        radial-gradient(900px 520px at 90% 10%, rgba(212,160,23,.10) 0%, rgba(248,244,239,1) 60%),
        var(--bg);
      color:var(--text);
    }

    header{
      max-width:1120px;
      margin:0 auto;
      padding:22px 18px 10px;
      display:flex;
      justify-content:space-between;
      gap:14px;
      align-items:flex-end;
    }
    .titleBlock h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
      color:var(--accent);
      line-height:1.2;
    }
    .titleBlock .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
      max-width:820px;
    }

    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:12px 18px 40px;
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }

    .topBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .tabs{
      display:flex;
      gap:8px;
      background: rgba(255,255,255,.65);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .tabBtn{
      border:0;
      cursor:pointer;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background:transparent;
      transition: 150ms ease;
      user-select:none;
    }
    .tabBtn[aria-selected="true"]{
      background: var(--accent);
      color:#fff;
      box-shadow: 0 10px 20px rgba(139,47,47,.18);
    }

    .chipRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .chip{
      font-size:11.5px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.7);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px;
      border-radius:999px;
      background: rgba(139,47,47,.55);
    }
    .dot.alt{ background: rgba(212,160,23,.65); }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1.05fr .95fr;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }

    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sectionHead h2{
      margin:0;
      font-size:14px;
      color:var(--accent);
      letter-spacing:.2px;
      font-weight:800;
    }
    .miniPill{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background: rgba(0,0,0,.04);
      user-select:none;
      white-space:nowrap;
    }

    .controls{
      display:grid;
      gap:10px;
    }
    .control{
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px;
    }
    .controlTop{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:6px;
    }
    .controlTop label{
      font-size:12px;
      color:var(--muted);
    }
    .controlTop .val{
      font-size:12px;
      color:var(--text);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }

    .hctRow{
      margin-top:8px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .tube{
      flex:1;
      height:14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.06);
      overflow:hidden;
      position:relative;
    }
    .tube .fill{
      height:100%;
      width:45%;
      background: rgba(139,47,47,.55);
    }
    .tube .plasma{
      position:absolute;
      right:0; top:0;
      height:100%;
      width:55%;
      background: rgba(255,255,255,.35);
    }
    .miniBadge{
      font-size:11.5px;
      color:var(--muted);
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      padding:4px 8px;
      border-radius:999px;
      font-weight:800;
      white-space:nowrap;
    }

    .kpis{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
      margin-top:12px;
    }
    @media (max-width: 560px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px;
    }
    .kpi .t{
      font-size:11.5px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .kpi .n{
      font-size:20px;
      font-weight:900;
      color:var(--accent);
      font-variant-numeric: tabular-nums;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
      line-height:1.1;
    }
    .mini{
      font-size:11.5px;
      color:var(--muted);
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      padding:3px 8px;
      border-radius:999px;
      font-weight:800;
    }

    .quickRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      border:1px solid rgba(0,0,0,.10);
      background: var(--accent);
      color:#fff;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      box-shadow: 0 8px 18px rgba(139,47,47,.14);
      user-select:none;
    }
    button:hover{ filter: brightness(1.05); }
    button.secondary{
      background:#fff;
      color:var(--accent);
      border:1px solid rgba(139,47,47,.55);
      box-shadow:none;
    }
    button.ghost{
      background: rgba(255,255,255,.55);
      color: var(--muted);
      border:1px solid var(--border);
      box-shadow:none;
    }

    .vizCard{ display:grid; gap:12px; }
    .canvasWrap{
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: 16px;
      padding:10px;
      overflow:hidden;
    }
    canvas{ width:100%; height:220px; display:block; }

    .splitBars{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .barRow{ display:grid; gap:8px; }
    .barTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .bar{
      height:14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.07);
      overflow:hidden;
      position:relative;
    }
    .fillCut{ height:100%; width:50%; background: rgba(139,47,47,.55); }
    .fillVis{ height:100%; width:50%; background: rgba(212,160,23,.55); }

    .legend{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      color:var(--muted);
      font-size:11.5px;
      user-select:none;
    }
    .key{
      display:flex; gap:8px; align-items:center;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.6);
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
<header>
  <div class="titleBlock">
    <h1>Hemodynamics Interactive</h1>
    <div class="sub">
      Focus: arterioles regulate blood flow by regulating <b>resistance</b>. In this lab, pressure is held constant in the background
      so you can isolate the relationships between <b>radius</b>, <b>resistance</b>, and <b>flow</b> (including redistribution in thermoregulation).
    </div>
  </div>

  <div class="chipRow">
    <div class="chip"><span class="dot"></span><span id="chipMode">Single Vessel</span></div>
    <div class="chip"><span class="dot alt"></span><span>Live</span></div>
  </div>
</header>

<div class="wrap">
  <div class="topBar">
    <div class="tabs" role="tablist" aria-label="Modes">
      <button class="tabBtn" id="tabSingle" role="tab" aria-selected="true" aria-controls="panelSingle">Single Vessel</button>
      <button class="tabBtn" id="tabSystem" role="tab" aria-selected="false" aria-controls="panelSystem">Systemic Redistribution</button>
    </div>

    <div class="chipRow">
      <div class="chip"><span class="dot"></span><span id="liveQ">Q: —</span></div>
      <div class="chip"><span class="dot alt"></span><span id="liveR">R: —</span></div>
    </div>
  </div>

  <!-- ===================== SINGLE VESSEL ===================== -->
  <section id="panelSingle" role="tabpanel" aria-labelledby="tabSingle">
    <div class="grid">
      <div class="card">
        <div class="sectionHead">
          <h2>Controls</h2>
          <span class="miniPill">ΔP held constant → Q ∝ r⁴ / (μ · L)</span>
        </div>

        <div class="controls">
          <div class="control">
            <div class="controlTop">
              <label for="r1">Radius (r)</label>
              <div class="val"><span id="r1Val"></span> ×</div>
            </div>
            <input id="r1" type="range" min="0.8" max="3.0" step="0.05" value="1.90"/>
          </div>

          <div class="control">
            <div class="controlTop">
              <label for="hct1">Hematocrit (Hct)</label>
              <div class="val"><span id="hct1Val"></span>%</div>
            </div>
            <input id="hct1" type="range" min="25" max="65" step="1" value="45"/>
            <div class="hctRow">
              <div class="tube" title="Hematocrit tube (conceptual)">
                <div class="fill" id="hct1Fill"></div>
                <div class="plasma" id="plasma1Fill"></div>
              </div>
              <div class="miniBadge" id="mu1Badge">μ: 1.00×</div>
            </div>
          </div>

          <div class="control">
            <div class="controlTop">
              <label for="l1">Length (L)</label>
              <div class="val"><span id="l1Val"></span> ×</div>
            </div>
            <input id="l1" type="range" min="0.7" max="3.0" step="0.05" value="1.00"/>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Flow (Q)</div>
            <div class="n">
              <span id="q1Out">—</span>
              <span class="mini" id="q1Rel">—</span>
            </div>
          </div>
          <div class="kpi">
            <div class="t">Resistance (R)</div>
            <div class="n">
              <span id="r1Out">—</span>
              <span class="mini" id="r1Rel">—</span>
            </div>
          </div>
        </div>

        <div class="quickRow">
          <button id="r1Dilate">+ r</button>
          <button id="r1Constrict">− r</button>
          <button class="ghost" id="hct1Down">↓ Hct</button>
          <button class="ghost" id="hct1Up">↑ Hct</button>
          <button class="secondary" id="reset1">Reset</button>
        </div>
      </div>

      <aside class="card vizCard">
        <div class="sectionHead">
          <h2>Vessel visualization</h2>
          <span class="miniPill">radius + relative speed</span>
        </div>
        <div class="canvasWrap">
          <canvas id="vessel"></canvas>
        </div>
      </aside>
    </div>
  </section>

  <!-- ===================== SYSTEMIC REDISTRIBUTION ===================== -->
  <section id="panelSystem" class="hidden" role="tabpanel" aria-labelledby="tabSystem">
    <div class="grid">
      <div class="card">
        <div class="sectionHead">
          <h2>Controls</h2>
          <span class="miniPill">Parallel beds: same MAP → distribution set by R</span>
        </div>

        <div class="controls">
          <div class="control">
            <div class="controlTop">
              <label>MAP (held constant)</label>
              <div class="val"><span id="mapVal"></span> mmHg</div>
            </div>
            <input type="range" min="90" max="90" step="1" value="90" disabled />
          </div>

          <div class="control">
            <div class="controlTop">
              <label for="hct2">Hematocrit (Hct)</label>
              <div class="val"><span id="hct2Val"></span>%</div>
            </div>
            <input id="hct2" type="range" min="25" max="65" step="1" value="45"/>
            <div class="hctRow">
              <div class="tube" title="Hematocrit tube (conceptual)">
                <div class="fill" id="hct2Fill"></div>
                <div class="plasma" id="plasma2Fill"></div>
              </div>
              <div class="miniBadge" id="mu2Badge">μ: 1.00×</div>
            </div>
          </div>

          <div class="control">
            <div class="controlTop">
              <label for="rCut">Cutaneous radius (r)</label>
              <div class="val"><span id="rCutVal"></span> ×</div>
            </div>
            <input id="rCut" type="range" min="0.8" max="3.0" step="0.05" value="1.90"/>
          </div>

          <div class="control">
            <div class="controlTop">
              <label for="rVis">Visceral radius (r)</label>
              <div class="val"><span id="rVisVal"></span> ×</div>
            </div>
            <input id="rVis" type="range" min="0.8" max="3.0" step="0.05" value="1.90"/>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Total Flow (Qtotal)</div>
            <div class="n">
              <span id="qTotOut">—</span>
              <span class="mini" id="qTotRel">—</span>
            </div>
          </div>
          <div class="kpi">
            <div class="t">Equivalent Resistance (Req)</div>
            <div class="n">
              <span id="reqOut">—</span>
              <span class="mini" id="reqRel">—</span>
            </div>
          </div>
        </div>

        <div class="splitBars">
          <div class="barRow">
            <div class="barTop">
              <span>Cutaneous share</span>
              <span id="shareCut">—</span>
            </div>
            <div class="bar"><div class="fillCut" id="fillCut"></div></div>
          </div>

          <div class="barRow">
            <div class="barTop">
              <span>Visceral share</span>
              <span id="shareVis">—</span>
            </div>
            <div class="bar"><div class="fillVis" id="fillVis"></div></div>
          </div>

          <div class="legend">
            <div class="key"><span class="dot"></span> Cutaneous</div>
            <div class="key"><span class="dot alt"></span> Visceral</div>
          </div>
        </div>

        <div class="quickRow">
          <button id="cutDilate">Cut + r</button>
          <button id="cutConstrict">Cut − r</button>
          <button id="visDilate">Vis + r</button>
          <button id="visConstrict">Vis − r</button>
          <button class="secondary" id="reset2">Reset</button>
        </div>
      </div>

      <aside class="card vizCard">
        <div class="sectionHead">
          <h2>Redistribution visualization</h2>
          <span class="miniPill">junction + particles</span>
        </div>
        <div class="canvasWrap">
          <canvas id="system"></canvas>
        </div>
      </aside>
    </div>
  </section>
</div>

<script>
  // ---------- Helpers ----------
  const el = (id) => document.getElementById(id);
  const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
  const fmt = (x, d=2) => Number(x).toFixed(d);

  // ---------- Hematocrit -> viscosity ----------
  const BASE_HCT = 0.45; // baseline fraction (45%)
  function hctToMuRel(hctFrac){
    const num = (1 - hctFrac);
    const den = (1 - BASE_HCT);
    return Math.pow(num / den, -2);
  }

  // Keep subtle apparent viscosity correction optional (small effect)
  function apparentMu(muRel, rNow){
    const corr = 1 - 0.12 * clamp((1.2 - rNow), 0, 1);
    return muRel * corr;
  }

  // ---------- Model core (pressure held constant -> scale only) ----------
  // We set a hidden constant ΔP for the single-vessel tab.
  const DP_CONST = 60;

  const calcQ = (dp, r, mu, l) => (dp * Math.pow(r,4)) / (mu * l);
  const calcR = (r, mu, l) => (mu * l) / Math.pow(r,4);

  // ---------- Tabs ----------
  const tabSingle = el("tabSingle");
  const tabSystem = el("tabSystem");
  const panelSingle = el("panelSingle");
  const panelSystem = el("panelSystem");
  const chipMode = el("chipMode");

  function setTab(which){
    const single = which === "single";
    tabSingle.setAttribute("aria-selected", String(single));
    tabSystem.setAttribute("aria-selected", String(!single));
    panelSingle.classList.toggle("hidden", !single);
    panelSystem.classList.toggle("hidden", single);
    chipMode.textContent = single ? "Single Vessel" : "Systemic Redistribution";
    updateLiveChips();
    requestAnimationFrame(() => { updateSingle(); updateSystem(); });
  }
  tabSingle.addEventListener("click", () => setTab("single"));
  tabSystem.addEventListener("click", () => setTab("system"));

  // ---------- Header live chips ----------
  const liveQ = el("liveQ");
  const liveR = el("liveR");

  // ---------- Single DOM ----------
  const r1 = el("r1"), hct1 = el("hct1"), l1 = el("l1");
  const r1Val = el("r1Val"), hct1Val = el("hct1Val"), l1Val = el("l1Val");
  const hct1Fill = el("hct1Fill"), plasma1Fill = el("plasma1Fill"), mu1Badge = el("mu1Badge");
  const q1Out = el("q1Out"), r1Out = el("r1Out"), q1Rel = el("q1Rel"), r1Rel = el("r1Rel");

  // ---------- System DOM ----------
  const MAP_CONST = 90;
  el("mapVal").textContent = fmt(MAP_CONST,0);

  const hct2 = el("hct2"), rCut = el("rCut"), rVis = el("rVis");
  const hct2Val = el("hct2Val"), rCutVal = el("rCutVal"), rVisVal = el("rVisVal");
  const hct2Fill = el("hct2Fill"), plasma2Fill = el("plasma2Fill"), mu2Badge = el("mu2Badge");
  const qTotOut = el("qTotOut"), qTotRel = el("qTotRel");
  const reqOut = el("reqOut"), reqRel = el("reqRel");
  const shareCut = el("shareCut"), shareVis = el("shareVis");
  const fillCut = el("fillCut"), fillVis = el("fillVis");

  // ---------- Canvas ----------
  const vessel = el("vessel");
  const vctx = vessel.getContext("2d");
  const system = el("system");
  const sctx = system.getContext("2d");

  function fitCanvas(c){
    const rect = c.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    c.width = Math.max(1, Math.floor(rect.width * dpr));
    c.height = Math.max(1, Math.floor(rect.height * dpr));
    return dpr;
  }

  // ---------- Baselines (for relative displays) ----------
  const BASE1 = { r: 1.90, hct: 45, l: 1.00 };
  const MU1_BASE = apparentMu(hctToMuRel(BASE1.hct/100), BASE1.r);
  const Q1_BASE  = calcQ(DP_CONST, BASE1.r, MU1_BASE, BASE1.l);
  const R1_BASE  = calcR(BASE1.r, MU1_BASE, BASE1.l);

  const BASE2 = { hct: 45, rCut: 1.90, rVis: 1.90 };
  const MU2_BASE = hctToMuRel(BASE2.hct/100);
  const RCUT_BASE = calcR(BASE2.rCut, MU2_BASE, 1.0);
  const RVIS_BASE = calcR(BASE2.rVis, MU2_BASE, 1.0);
  const REQ_BASE = 1 / (1/RCUT_BASE + 1/RVIS_BASE);
  const QT_BASE = MAP_CONST / REQ_BASE;

  // ---------- Single vessel visualization ----------
  let t = 0;

  function drawVessel(rNow, qRatio){
    const dpr = fitCanvas(vessel);
    const w = vessel.width, h = vessel.height;

    vctx.clearRect(0,0,w,h);

    const midY = h * 0.55;
    const leftX = w * 0.10;
    const rightX = w * 0.90;

    const rPx = (rNow / 3.0) * (h * 0.22) + (h * 0.06);
    const speed = clamp(qRatio, 0.15, 4.2);

    vctx.strokeStyle = "rgba(0,0,0,.22)";
    vctx.lineWidth = Math.max(2*dpr, (rPx*2) * 0.06);
    vctx.beginPath();
    vctx.moveTo(leftX, midY - rPx); vctx.lineTo(rightX, midY - rPx);
    vctx.moveTo(leftX, midY + rPx); vctx.lineTo(rightX, midY + rPx);
    vctx.stroke();

    const n = 20;
    const span = (rightX - leftX);
    const spacing = span / n;
    vctx.fillStyle = "rgba(139,47,47,.85)";

    for(let i=0;i<n;i++){
      const x = leftX + ((i*spacing + (t*speed*2.3*dpr)) % span);
      const y = midY + Math.sin((i*1.6 + t*0.02)*2) * (rPx*0.55);
      const rad = 2.3*dpr;
      vctx.beginPath();
      vctx.arc(x, y, rad, 0, Math.PI*2);
      vctx.fill();
    }

    vctx.fillStyle = "rgba(95,95,95,.95)";
    vctx.font = `${12*dpr}px system-ui`;
    vctx.textAlign = "left";
    vctx.textBaseline = "top";
    vctx.fillText(`r ${fmt(rNow,2)}×   Q ${fmt(qRatio,2)}×`, leftX, h*0.07);
  }

  function updateSingle(){
    const rNow = Number(r1.value);
    const hctPct = Number(hct1.value);
    const lNow = Number(l1.value);

    const muRel = hctToMuRel(hctPct/100);
    const muEff = apparentMu(muRel, rNow);

    r1Val.textContent = fmt(rNow,2);
    hct1Val.textContent = fmt(hctPct,0);
    l1Val.textContent = fmt(lNow,2);

    hct1Fill.style.width = `${hctPct}%`;
    plasma1Fill.style.width = `${100 - hctPct}%`;
    mu1Badge.textContent = `μ: ${fmt(muEff,2)}×`;

    const qNow = calcQ(DP_CONST, rNow, muEff, lNow);
    const rNowRes = calcR(rNow, muEff, lNow);

    const qRatio = qNow / Q1_BASE;
    const rRatio = rNowRes / R1_BASE;

    q1Out.textContent = fmt(qNow,2);
    r1Out.textContent = fmt(rNowRes,4);
    q1Rel.textContent = `${fmt(qRatio,2)}×`;
    r1Rel.textContent = `${fmt(rRatio,2)}×`;

    drawVessel(rNow, qRatio);
    updateLiveChips();
  }

  // ---------- System visualization ----------
  const lerp = (a,b,t) => a + (b-a)*t;

  function drawTube(ctx, a, b, radiusPx, stroke){
    const dx = b.x - a.x;
    const dy = b.y - a.y;
    const L = Math.max(1e-6, Math.hypot(dx,dy));
    const nx = -dy / L;
    const ny =  dx / L;

    ctx.strokeStyle = stroke;
    ctx.lineWidth = Math.max(1, radiusPx * 0.18);
    ctx.lineCap = "round";

    ctx.beginPath();
    ctx.moveTo(a.x + nx*radiusPx, a.y + ny*radiusPx);
    ctx.lineTo(b.x + nx*radiusPx, b.y + ny*radiusPx);
    ctx.moveTo(a.x - nx*radiusPx, a.y - ny*radiusPx);
    ctx.lineTo(b.x - nx*radiusPx, b.y - ny*radiusPx);
    ctx.stroke();
  }

  function pointOnSegment(a,b,u){
    return { x: lerp(a.x,b.x,u), y: lerp(a.y,b.y,u) };
  }

  function drawParticlesOnSegment(ctx, a, b, radiusPx, nDots, speed, color, phase){
    const dx = b.x - a.x;
    const dy = b.y - a.y;
    const segLen = Math.max(1e-6, Math.hypot(dx,dy));
    const ux = dx / segLen;
    const uy = dy / segLen;
    const nx = -uy, ny = ux;

    const amp = radiusPx * 0.55;
    const rad = Math.max(1.8, radiusPx * 0.10);

    ctx.fillStyle = color;

    for (let i=0;i<nDots;i++){
      const u = ((i / nDots) + phase + (t * speed * 0.003)) % 1;
      const p = pointOnSegment(a,b,u);

      const wob = Math.sin((i*1.7 + t*0.02) * 2) * amp;
      const x = p.x + nx * wob;
      const y = p.y + ny * wob;

      ctx.beginPath();
      ctx.arc(x, y, rad, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function drawJunction2(fracCut, fracVis, qTotalRatio){
    const dpr = fitCanvas(system);
    const w = system.width, h = system.height;
    sctx.clearRect(0,0,w,h);

    const J = { x: w*0.50, y: h*0.46 };
    const trunkTop = { x: w*0.50, y: h*0.12 };
    const CutEnd = { x: w*0.20, y: h*0.82 };
    const VisEnd = { x: w*0.80, y: h*0.82 };

    const base = h * 0.060;
    const rTrunk = clamp(base * (0.80 + qTotalRatio*0.20), base*0.65, base*1.15);
    const rCutPx = clamp(base * (0.45 + fracCut*1.35), base*0.35, base*1.80);
    const rVisPx = clamp(base * (0.45 + fracVis*1.35), base*0.35, base*1.80);

    drawTube(sctx, trunkTop, J, rTrunk, "rgba(0,0,0,.22)");
    drawTube(sctx, J, CutEnd, rCutPx, "rgba(0,0,0,.20)");
    drawTube(sctx, J, VisEnd, rVisPx, "rgba(0,0,0,.20)");

    const trunkSpeed = clamp(qTotalRatio, 0.25, 3.0);
    const cutSpeed = clamp(trunkSpeed * (0.65 + fracCut*1.1), 0.25, 3.2);
    const visSpeed = clamp(trunkSpeed * (0.65 + fracVis*1.1), 0.25, 3.2);

    const baseDots = Math.round(14 + 10*clamp(qTotalRatio,0,2));
    const nT = Math.max(10, Math.round(baseDots * 1.1));
    const nC = Math.max(8, Math.round(baseDots * (0.6 + fracCut)));
    const nV = Math.max(8, Math.round(baseDots * (0.6 + fracVis)));

    drawParticlesOnSegment(sctx, trunkTop, J, rTrunk, nT, trunkSpeed, "rgba(0,0,0,.14)", 0.05);
    drawParticlesOnSegment(sctx, J, CutEnd, rCutPx, nC, cutSpeed, "rgba(139,47,47,.82)", 0.18);
    drawParticlesOnSegment(sctx, J, VisEnd, rVisPx, nV, visSpeed, "rgba(212,160,23,.82)", 0.42);

    sctx.fillStyle = "rgba(95,95,95,.95)";
    sctx.font = `${12*dpr}px system-ui`;

    sctx.textAlign = "center";
    sctx.textBaseline = "bottom";
    sctx.fillText("MAP", trunkTop.x, trunkTop.y - 6*dpr);

    sctx.textBaseline = "middle";
    sctx.textAlign = "left";
    sctx.fillText(`Cutaneous  ${Math.round(fracCut*100)}%`, CutEnd.x + 10*dpr, CutEnd.y);

    sctx.textAlign = "right";
    sctx.fillText(`Visceral  ${Math.round(fracVis*100)}%`, VisEnd.x - 10*dpr, VisEnd.y);
  }

  function updateSystem(){
    const hctPct = Number(hct2.value);
    const rCutNow = Number(rCut.value);
    const rVisNow = Number(rVis.value);

    const muRel = hctToMuRel(hctPct/100);

    hct2Val.textContent = fmt(hctPct,0);
    rCutVal.textContent = fmt(rCutNow,2);
    rVisVal.textContent = fmt(rVisNow,2);

    hct2Fill.style.width = `${hctPct}%`;
    plasma2Fill.style.width = `${100 - hctPct}%`;
    mu2Badge.textContent = `μ: ${fmt(muRel,2)}×`;

    // Resistances of each bed (parallel)
    const Rcut = calcR(rCutNow, muRel, 1.0);
    const Rvis = calcR(rVisNow, muRel, 1.0);

    const Req = 1 / (1/Rcut + 1/Rvis);

    // Total flow given constant MAP
    const Qtot = MAP_CONST / Req;

    // Branch flows (same MAP across beds; distribution set by resistance)
    const Qcut = MAP_CONST / Rcut;
    const Qvis = MAP_CONST / Rvis;

    const total = Qcut + Qvis;
    const fracCut = Qcut / total;
    const fracVis = Qvis / total;

    qTotOut.textContent = fmt(Qtot,2);
    qTotRel.textContent = `${fmt(Qtot / QT_BASE,2)}×`;

    reqOut.textContent = fmt(Req,4);
    reqRel.textContent = `${fmt(Req / REQ_BASE,2)}×`;

    shareCut.textContent = `${fmt(fracCut*100,0)}%`;
    shareVis.textContent = `${fmt(fracVis*100,0)}%`;
    fillCut.style.width = `${fmt(fracCut*100,0)}%`;
    fillVis.style.width = `${fmt(fracVis*100,0)}%`;

    drawJunction2(fracCut, fracVis, Qtot / QT_BASE);
    updateLiveChips();
  }

  function updateLiveChips(){
    const inSingle = tabSingle.getAttribute("aria-selected") === "true";
    if (inSingle){
      const rNow = Number(r1.value);
      const hctPct = Number(hct1.value);
      const lNow = Number(l1.value);
      const muRel = hctToMuRel(hctPct/100);
      const muEff = apparentMu(muRel, rNow);

      const qNow = calcQ(DP_CONST, rNow, muEff, lNow);
      const rNowRes = calcR(rNow, muEff, lNow);

      liveQ.textContent = `Q: ${fmt(qNow,2)}`;
      liveR.textContent = `R: ${fmt(rNowRes,4)}`;
    } else {
      const hctPct = Number(hct2.value);
      const muRel = hctToMuRel(hctPct/100);
      const rCutNow = Number(rCut.value);
      const rVisNow = Number(rVis.value);

      const Rcut = calcR(rCutNow, muRel, 1.0);
      const Rvis = calcR(rVisNow, muRel, 1.0);
      const Req = 1 / (1/Rcut + 1/Rvis);
      const Qtot = MAP_CONST / Req;

      liveQ.textContent = `Qtotal: ${fmt(Qtot,2)}`;
      liveR.textContent = `Req: ${fmt(Req,4)}`;
    }
  }

  // ---------- Buttons ----------
  // Single
  el("r1Dilate").addEventListener("click", () => {
    r1.value = clamp(Number(r1.value) * 1.20, Number(r1.min), Number(r1.max));
    updateSingle();
  });
  el("r1Constrict").addEventListener("click", () => {
    r1.value = clamp(Number(r1.value) * 0.80, Number(r1.min), Number(r1.max));
    updateSingle();
  });
  el("hct1Down").addEventListener("click", () => {
    hct1.value = clamp(Number(hct1.value) - 6, Number(hct1.min), Number(hct1.max));
    updateSingle();
  });
  el("hct1Up").addEventListener("click", () => {
    hct1.value = clamp(Number(hct1.value) + 6, Number(hct1.min), Number(hct1.max));
    updateSingle();
  });
  el("reset1").addEventListener("click", () => {
    r1.value = BASE1.r; hct1.value = BASE1.hct; l1.value = BASE1.l;
    updateSingle();
  });

  // System
  el("cutDilate").addEventListener("click", () => {
    rCut.value = clamp(Number(rCut.value) * 1.20, Number(rCut.min), Number(rCut.max));
    updateSystem();
  });
  el("cutConstrict").addEventListener("click", () => {
    rCut.value = clamp(Number(rCut.value) * 0.80, Number(rCut.min), Number(rCut.max));
    updateSystem();
  });
  el("visDilate").addEventListener("click", () => {
    rVis.value = clamp(Number(rVis.value) * 1.20, Number(rVis.min), Number(rVis.max));
    updateSystem();
  });
  el("visConstrict").addEventListener("click", () => {
    rVis.value = clamp(Number(rVis.value) * 0.80, Number(rVis.min), Number(rVis.max));
    updateSystem();
  });
  el("reset2").addEventListener("click", () => {
    hct2.value = BASE2.hct;
    rCut.value = BASE2.rCut;
    rVis.value = BASE2.rVis;
    updateSystem();
  });

  // ---------- Events ----------
  [r1,hct1,l1].forEach(s => s.addEventListener("input", updateSingle));
  [hct2,rCut,rVis].forEach(s => s.addEventListener("input", updateSystem));
  window.addEventListener("resize", () => { updateSingle(); updateSystem(); });

  // ---------- Animation loop ----------
  function tick(){
    t++;
    const inSingle = tabSingle.getAttribute("aria-selected") === "true";
    if (inSingle){
      const rNow = Number(r1.value);
      const hctPct = Number(hct1.value);
      const lNow = Number(l1.value);

      const muRel = hctToMuRel(hctPct/100);
      const muEff = apparentMu(muRel, rNow);

      const qNow = calcQ(DP_CONST, rNow, muEff, lNow);
      drawVessel(rNow, qNow / Q1_BASE);
    } else {
      // Redraw junction smoothly
      const hctPct = Number(hct2.value);
      const muRel = hctToMuRel(hctPct/100);
      const rCutNow = Number(rCut.value);
      const rVisNow = Number(rVis.value);

      const Rcut = calcR(rCutNow, muRel, 1.0);
      const Rvis = calcR(rVisNow, muRel, 1.0);

      const Qcut = MAP_CONST / Rcut;
      const Qvis = MAP_CONST / Rvis;

      const total = Qcut + Qvis;
      const fracCut = Qcut / total;
      const fracVis = Qvis / total;

      const Req = 1 / (1/Rcut + 1/Rvis);
      const Qtot = MAP_CONST / Req;

      drawJunction2(fracCut, fracVis, Qtot / QT_BASE);
    }
    requestAnimationFrame(tick);
  }

  // ---------- Init ----------
  setTab("single");
  updateSingle();
  updateSystem();
  requestAnimationFrame(tick);
</script>
</body>
</html>
